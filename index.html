<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>مفقود - Mafqood</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <!-- Firebase Libraries -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

  <style>
    body {
      font-family: 'Tajawal', sans-serif;
    }
  </style>
</head>
<body class="bg-gray-100">
  <!-- Header -->
  <header class="bg-white shadow p-4 flex justify-between items-center">
    <h1 class="text-2xl font-bold text-gray-800">مفقود - Mafqood</h1>
    <div>
      <button onclick="switchLang('ar')" class="mx-2 text-blue-500">عربي</button>
      <button onclick="switchLang('en')" class="mx-2 text-blue-500">English</button>
    </div>
  </header>

  <!-- Filters -->
  <section class="p-4">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <select class="p-2 rounded border" id="statusFilter">
        <option value="">كل الحالات</option>
        <option value="أسير">أسير</option>
        <option value="مفقود">مفقود</option>
      </select>
      <input type="text" placeholder="ابحث حسب المنطقة..." class="p-2 rounded border" id="locationFilter">
      <button onclick="applyFilters()" class="bg-blue-500 text-white px-4 py-2 rounded">تصفية</button>
    </div>
  </section>

  <!-- People Cards -->
  <section class="p-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6" id="peopleList">
    <!-- Cards generated by JS -->
  </section>

  <!-- Detail Modal -->
  <div id="detailModal" class="fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center z-50">
    <div class="bg-white w-full max-w-lg p-6 rounded shadow relative">
      <button onclick="closeModal()" class="text-red-500 absolute top-2 right-2">إغلاق</button>
      <div id="detailContent" class="mt-8"></div>
    </div>
  </div>

  <!-- Add Entry Form -->
  <section class="p-4">
    <h2 class="text-xl font-bold mb-4">نموذج التبليغ عن مفقود / أسير</h2>
    <form id="reportForm" class="grid grid-cols-1 gap-4 bg-white p-4 rounded shadow">
      <input type="text" placeholder="الاسم الكامل" class="p-2 border rounded" required>
      <input type="text" placeholder="المنطقة" class="p-2 border rounded" required>
      <input type="date" placeholder="تاريخ الفقدان / الاعتقال" class="p-2 border rounded" required>
      <select class="p-2 border rounded" required>
        <option value="">اختر الحالة</option>
        <option value="مفقود">مفقود</option>
        <option value="أسير">أسير</option>
      </select>
      <input type="file" class="p-2 border rounded" accept="image/*" required>
      <textarea placeholder="تفاصيل إضافية" class="p-2 border rounded"></textarea>
      <button type="submit" class="bg-green-600 text-white py-2 rounded">إرسال</button>
    </form>
  </section>

  <script>
    // TODO: ضع هنا مفاتيح مشروعك من Firebase
    const firebaseConfig = {
  apiKey: "AIzaSyDB48gtWPq0bNZsSeN8ddfcGtsQI2V2v-o",
  authDomain: "mafqood-ad057.firebaseapp.com",
  projectId: "mafqood-ad057",
  storageBucket: "mafqood-ad057.appspot.com",
  messagingSenderId: "845772117826",
  appId: "845772117826"
};

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    // Handle form submission
    document.getElementById("reportForm").addEventListener("submit", async function(e) {
      e.preventDefault();

      const form = e.target;
      const name = form[0].value;
      const location = form[1].value;
      const date = form[2].value;
      const status = form[3].value;
      const imageFile = form[4].files[0];
      const details = form[5].value;

      if (!imageFile) {
        alert("يرجى رفع صورة.");
        return;
      }

      try {
        // رفع الصورة
        const storageRef = storage.ref(`images/${Date.now()}_${imageFile.name}`);
        await storageRef.put(imageFile);
        const imageUrl = await storageRef.getDownloadURL();

        // حفظ البيانات في Firestore
        await db.collection("people").add({
          name,
          location,
          date,
          status,
          details,
          image: imageUrl,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });

        alert("تم التبليغ بنجاح.");
        form.reset();
        fetchPeople();
      } catch (error) {
        console.error("Error uploading data:", error);
        alert("حدث خطأ أثناء رفع البيانات.");
      }
    });

    // Fetch and display data
    async function fetchPeople() {
      try {
        const snapshot = await db.collection("people").orderBy("timestamp", "desc").get();
        const people = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderPeople(people);
      } catch (error) {
        console.error("Error fetching data:", error);
      }
    }

    function renderPeople(people) {
      const container = document.getElementById('peopleList');
      container.innerHTML = '';
      people.forEach(person => {
        const card = document.createElement('div');
        card.className = "bg-white p-4 rounded shadow cursor-pointer";
        card.onclick = () => showDetails(person);
        card.innerHTML = `
          <img src="${person.image}" alt="صورة الشخص" class="w-full h-48 object-cover rounded mb-4">
          <h2 class="text-xl font-bold mb-1">${person.name}</h2>
          <p>الحالة: <span class="text-red-500">${person.status}</span></p>
          <p>المنطقة: ${person.location}</p>
          <p>تاريخ الفقدان: ${person.date}</p>
        `;
        container.appendChild(card);
      });
    }

    function showDetails(person) {
      document.getElementById('detailContent').innerHTML = `
        <img src="${person.image}" class="w-full h-64 object-cover rounded mb-4">
        <h2 class="text-2xl font-bold mb-2">${person.name}</h2>
        <p><strong>الحالة:</strong> ${person.status}</p>
        <p><strong>المنطقة:</strong> ${person.location}</p>
        <p><strong>تاريخ الفقدان / الاعتقال:</strong> ${person.date}</p>
        <p class="mt-2">${person.details}</p>
      `;
      document.getElementById('detailModal').classList.remove('hidden');
      document.getElementById('detailModal').classList.add('flex');
    }

    function closeModal() {
      document.getElementById('detailModal').classList.add('hidden');
    }

    function applyFilters() {
      const statusValue = document.getElementById('statusFilter').value;
      const locationValue = document.getElementById('locationFilter').value.trim();

      db.collection('people')
        .orderBy("timestamp", "desc")
        .get()
        .then(snapshot => {
          let people = snapshot.docs.map(doc => doc.data());

          if (statusValue) {
            people = people.filter(p => p.status === statusValue);
          }
          if (locationValue) {
            people = people.filter(p => p.location.includes(locationValue));
          }

          renderPeople(people);
        })
        .catch(error => {
          console.error("Error filtering:", error);
        });
    }

    function switchLang(lang) {
      document.documentElement.lang = lang;
      document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
    }

    // Load data at start
    fetchPeople();
  </script>
</body>
</html>